<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="theme-color" content="#111b21">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Lotus AI">
    
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    
    <title>LotusAI | Neural Interface</title>
    
    <!-- ƒ∞KONLAR VE FONT -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- MARKDOWN VE KOD RENKLENDƒ∞RME -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <style>
        :root {
            /* Renk Paleti (Sci-Fi Dark) */
            --bg-dark: #0f1115;
            --panel-bg: rgba(30, 34, 40, 0.95);
            --panel-border: rgba(255, 255, 255, 0.08);
            
            --user-msg-bg: #2b5278; /* Mavi Tonlu */
            --agent-msg-bg: #1e2228;
            
            --text-primary: #e9edef;
            --text-secondary: #8b9bb4;
            
            --accent: #64b5f6;
            
            /* Ajan Renkleri */
            --color-atlas: #29b6f6;   /* A√ßƒ±k Mavi */
            --color-gaya: #f06292;    /* Pembe */
            --color-sidar: #66bb6a;   /* Ye≈üil */
            --color-kurt: #ffee58;    /* Sarƒ± */
            --color-poyraz: #ffa726;  /* Turuncu */
            --color-kerberos: #ef5350;/* Kƒ±rmƒ±zƒ± */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Scrollbar Tasarƒ±mƒ± */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .app-container {
            display: flex;
            height: 100dvh;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
            position: relative;
            background: radial-gradient(circle at 50% 50%, #1a202c 0%, #0f1115 100%);
        }

        /* --- SOL PANEL: AJAN Lƒ∞STESƒ∞ --- */
        #contact-list-view {
            width: 320px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: rgba(15, 17, 21, 0.95);
            border-right: 1px solid var(--panel-border);
            backdrop-filter: blur(10px);
            z-index: 5;
            transition: transform 0.3s ease;
        }

        .list-header {
            height: 70px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--panel-border);
        }

        .brand-title {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: -1px;
            font-size: 1.2rem;
            
            /* D√úZELTƒ∞LDƒ∞: Gradyan Metin Standartlarƒ± */
            background-image: linear-gradient(90deg, #fff, #8b9bb4);
            background-clip: text;          /* Standart */
            -webkit-background-clip: text;  /* Safari/Chrome */
            color: transparent;             /* Standart Yedek */
            -webkit-text-fill-color: transparent;
        }

        .contacts-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 5px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .contact-item:hover { background-color: rgba(255,255,255,0.03); }
        
        .contact-item.active { 
            background-color: rgba(255,255,255,0.05); 
            border-color: rgba(255,255,255,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            background: rgba(255,255,255,0.05);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
        }

        .contact-info { flex: 1; overflow: hidden; }

        .contact-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: block;
        }

        .contact-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        /* --- SAƒû PANEL: SOHBET --- */
        #chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
            width: 100%;
        }

        /* Mobil ƒ∞√ßin Panel Ge√ßi≈üi */
        @media (max-width: 768px) {
            #contact-list-view { width: 100%; position: absolute; z-index: 20; }
            #chat-view { position: absolute; top: 0; left: 0; height: 100%; width: 100%; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 30; background: var(--bg-dark); }
            #chat-view.active { transform: translateX(0); }
            .desktop-only { display: none !important; }
        }

        .chat-header {
            height: 70px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--panel-border);
            background: rgba(15, 17, 21, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background-color: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #2b5278 0%, #1e3a56 100%);
            border-bottom-right-radius: 2px;
            color: #fff;
        }

        .message.agent {
            align-self: flex-start;
            background-color: var(--agent-msg-bg);
            border: 1px solid var(--panel-border);
            border-bottom-left-radius: 2px;
        }

        .msg-sender {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
            letter-spacing: 0.5px;
            font-family: 'JetBrains Mono', monospace;
        }

        .msg-content {
            word-wrap: break-word;
        }

        /* Markdown Stilleri */
        .msg-content p { margin: 0 0 8px 0; }
        .msg-content p:last-child { margin: 0; }
        .msg-content code { background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }
        .msg-content pre { margin: 10px 0; border-radius: 8px; overflow: hidden; background: #282c34 !important; }
        .msg-content pre code { background: transparent; padding: 15px; display: block; overflow-x: auto; color: #abb2bf; }
        .msg-content ul, .msg-content ol { margin: 5px 0; padding-left: 20px; }
        .msg-content strong { color: #fff; font-weight: 600; }

        .msg-time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            text-align: right;
            margin-top: 5px;
        }

        /* --- INPUT ALANI --- */
        .chat-footer {
            padding: 20px;
            background: rgba(15, 17, 21, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--panel-border);
            display: flex;
            align-items: flex-end;
            gap: 12px;
            position: relative;
        }

        .input-wrapper {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 2px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: border-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .input-wrapper:focus-within { border-color: rgba(255,255,255,0.2); }

        .input-box {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            padding: 12px 15px;
            outline: none;
            max-height: 120px;
            overflow-y: auto;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .action-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .action-btn.send { background: var(--accent); color: #000; }
        .action-btn.send:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(100, 181, 246, 0.4); }
        .action-btn.active { color: #4caf50; background: rgba(76, 175, 80, 0.1); }

        #file-preview {
            padding: 8px 15px;
            font-size: 0.85rem;
            color: var(--accent);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: none;
        }

        /* --- TYPING INDICATOR --- */
        .typing-wave {
            display: none;
            align-items: center;
            gap: 3px;
            padding: 5px 10px;
        }
        .typing-wave span {
            width: 4px;
            height: 4px;
            background-color: var(--accent);
            border-radius: 50%;
            animation: wave 1s infinite ease-in-out;
        }
        .typing-wave span:nth-child(1) { animation-delay: 0s; }
        .typing-wave span:nth-child(2) { animation-delay: 0.1s; }
        .typing-wave span:nth-child(3) { animation-delay: 0.2s; }
        
        @keyframes wave { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Gizli Elemanlar */
        #auth-video, #auth-canvas, #file-input { display: none; }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            opacity: 0.5;
        }
    </style>
</head>
<body>

<!-- Gƒ∞ZLƒ∞ G√úVENLƒ∞K KAMERASI -->
<video id="auth-video" autoplay playsinline></video>
<canvas id="auth-canvas"></canvas>

<div class="app-container">
    
    <!-- SOL PANEL -->
    <div id="contact-list-view">
        <div class="list-header">
            <div class="brand-title"><i class="fas fa-brain" style="margin-right:10px; color: var(--accent);"></i>LOTUS AI</div>
            <i class="fas fa-camera" id="camera-status" title="Kamera Durumu" style="color: #4caf50; opacity: 0.5;"></i>
        </div>
        
        <div class="contacts-scroll">
            <div class="contact-item active" onclick="selectRoom('GENEL', 'Lotus Takƒ±m (Genel)', 'var(--accent)')">
                <div class="contact-avatar" style="color: var(--accent);">üë•</div>
                <div class="contact-info">
                    <span class="contact-name">Lotus Takƒ±m</span>
                    <span class="contact-role">Genel Sohbet</span>
                </div>
            </div>

            <div class="contact-item" onclick="selectRoom('ATLAS', 'Atlas', 'var(--color-atlas)')">
                <div class="contact-avatar" style="color: var(--color-atlas);">üåê</div>
                <div class="contact-info">
                    <span class="contact-name">Atlas</span>
                    <span class="contact-role">Proje Y√∂neticisi</span>
                </div>
            </div>

            <div class="contact-item" onclick="selectRoom('Sƒ∞DAR', 'Sidar', 'var(--color-sidar)')">
                <div class="contact-avatar" style="color: var(--color-sidar);">üíª</div>
                <div class="contact-info">
                    <span class="contact-name">Sidar</span>
                    <span class="contact-role">Yazƒ±lƒ±m Mimarƒ±</span>
                </div>
            </div>

            <div class="contact-item" onclick="selectRoom('KURT', 'Kurt', 'var(--color-kurt)')">
                <div class="contact-avatar" style="color: var(--color-kurt);">üê∫</div>
                <div class="contact-info">
                    <span class="contact-name">Kurt</span>
                    <span class="contact-role">Finans Stratejisti</span>
                </div>
            </div>
            
            <div class="contact-item" onclick="selectRoom('GAYA', 'Gaya', 'var(--color-gaya)')">
                <div class="contact-avatar" style="color: var(--color-gaya);">ü™∑</div>
                <div class="contact-info">
                    <span class="contact-name">Gaya</span>
                    <span class="contact-role">ƒ∞≈ületme M√ºd√ºr√º</span>
                </div>
            </div>

            <div class="contact-item" onclick="selectRoom('POYRAZ', 'Poyraz', 'var(--color-poyraz)')">
                <div class="contact-avatar" style="color: var(--color-poyraz);">üå™Ô∏è</div>
                <div class="contact-info">
                    <span class="contact-name">Poyraz</span>
                    <span class="contact-role">Medya Direkt√∂r√º</span>
                </div>
            </div>

            <div class="contact-item" onclick="selectRoom('KERBEROS', 'Kerberos', 'var(--color-kerberos)')">
                <div class="contact-avatar" style="color: var(--color-kerberos);">üõ°Ô∏è</div>
                <div class="contact-info">
                    <span class="contact-name">Kerberos</span>
                    <span class="contact-role">G√ºvenlik ≈ûefi</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAƒû PANEL -->
    <div id="chat-view">
        <div class="chat-header">
            <div class="chat-user-info">
                <button class="action-btn desktop-only" onclick="toggleSidebar()" style="display:none;"><i class="fas fa-bars"></i></button>
                <button class="action-btn" onclick="closeChatMobile()" style="display:none; margin-right:5px;" id="mobile-back"><i class="fas fa-arrow-left"></i></button>
                
                <div class="contact-avatar" id="header-avatar" style="width: 40px; height: 40px; font-size: 1.2rem; margin:0;">üë•</div>
                <div>
                    <h3 id="header-title" style="margin:0; font-size:1rem; font-weight:600;">Lotus Takƒ±m</h3>
                    <div style="font-size:0.75rem; color:var(--text-secondary); display:flex; align-items:center;">
                        <span class="status-dot"></span>√áevrimi√ßi
                        <div class="typing-wave" id="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="action-btn" id="voice-call-btn" onclick="toggleBackendVoice()" title="S√ºrekli Dinleme Modu"><i class="fas fa-headset"></i></button>
            </div>
        </div>

        <div class="messages-area" id="messages-area">
            <div class="empty-state">
                <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <p>Lotus Neural Interface v2.5</p>
            </div>
        </div>

        <div class="chat-footer">
            <label for="file-input" class="action-btn" title="Dosya/Resim Y√ºkle">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="file-input" onchange="handleFile()">

            <div class="input-wrapper">
                <div id="file-preview"></div>
                <textarea class="input-box" id="msg-input" placeholder="Bir komut girin..." rows="1" onkeypress="handleEnter(event)"></textarea>
            </div>
            
            <button class="action-btn" id="mic-btn" onclick="toggleLocalVoice()" title="Bas-Konu≈ü"><i class="fas fa-microphone"></i></button>
            <button class="action-btn send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

</div>

<script>
    // --- KONFƒ∞G√úRASYON ---
    let currentAgent = "GENEL";
    
    // Markdown Ayarlarƒ±
    marked.setOptions({
        breaks: true, // Satƒ±r sonlarƒ±nƒ± <br> yap
        highlight: function(code, lang) {
            const language = highlight.getLanguage(lang) ? lang : 'plaintext';
            return highlight.highlight(code, { language }).value;
        }
    });

    const agentColors = {
        'ATLAS': '#29b6f6', 'GAYA': '#f06292', 'Sƒ∞DAR': '#66bb6a',
        'KURT': '#ffee58', 'POYRAZ': '#ffa726', 'KERBEROS': '#ef5350', 'GENEL': '#64b5f6'
    };
    
    const agentIcons = {
        'ATLAS': 'üåê', 'GAYA': 'ü™∑', 'Sƒ∞DAR': 'üíª',
        'KURT': 'üê∫', 'POYRAZ': 'üå™Ô∏è', 'KERBEROS': 'üõ°Ô∏è', 'GENEL': 'üë•'
    };

    // --- BA≈ûLANGI√á ---
    window.onload = () => {
        loadChatHistory('GENEL');
        checkMobileView();
        
        // TextArea Auto-Resize
        const tx = document.getElementById('msg-input');
        tx.addEventListener("input", function(){
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });
    };

    window.onresize = checkMobileView;

    function checkMobileView() {
        const backBtn = document.getElementById('mobile-back');
        if (window.innerWidth <= 768) {
            backBtn.style.display = 'flex';
        } else {
            backBtn.style.display = 'none';
            document.getElementById('contact-list-view').style.transform = 'translateX(0)';
            document.getElementById('chat-view').style.transform = 'translateX(0)';
        }
    }

    // --- ODA Y√ñNETƒ∞Mƒ∞ ---
    async function selectRoom(agentKey, title, colorVar) {
        currentAgent = agentKey;
        
        // Header G√ºncelle
        document.getElementById('header-title').innerText = title;
        document.getElementById('header-avatar').innerHTML = agentIcons[agentKey] || 'ü§ñ';
        document.getElementById('header-avatar').style.color = agentColors[agentKey] || '#fff';
        
        // Sol men√º aktiflik
        document.querySelectorAll('.contact-item').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Mobilde sohbeti a√ß
        if (window.innerWidth <= 768) {
            document.getElementById('chat-view').classList.add('active');
        }

        await loadChatHistory(agentKey);
    }

    function closeChatMobile() {
        document.getElementById('chat-view').classList.remove('active');
    }

    // --- SOHBET Y√ñNETƒ∞Mƒ∞ ---
    async function loadChatHistory(agent) {
        const area = document.getElementById('messages-area');
        area.innerHTML = `<div class="empty-state"><i class="fas fa-circle-notch fa-spin"></i><p>Veriler y√ºkleniyor...</p></div>`;

        try {
            const res = await fetch(`/api/chat_history?agent=${agent}`);
            const data = await res.json();
            area.innerHTML = ''; 

            if (data.status === 'success' && data.history && data.history.length > 0) {
                data.history.forEach(msg => {
                    addMessageToUI(msg.sender, msg.text, msg.type, msg.time);
                });
            } else {
                area.innerHTML = `<div class="empty-state"><p>Bu kanalda hen√ºz mesaj yok.</p></div>`;
            }
            scrollToBottom();
        } catch (e) { console.error(e); }
    }

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const fileInput = document.getElementById('file-input');
        const text = input.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) return;

        // Kullanƒ±cƒ± Mesajƒ±nƒ± Ekle
        addMessageToUI('Siz', text, 'user', getCurrentTime());
        
        // UI Temizle
        input.value = '';
        input.style.height = 'auto';
        clearFile();
        showTyping(true);

        const formData = new FormData();
        formData.append('message', text);
        formData.append('target_agent', currentAgent);
        if (file) formData.append('file', file);

        // G√ºvenlik Snapshot
        const faceBlob = await captureSnapshot();
        if (faceBlob) formData.append('auth_frame', faceBlob, 'auth.jpg');

        try {
            const res = await fetch('/api/chat', { method: 'POST', body: formData });
            const data = await res.json();
            showTyping(false);

            if (data.status === 'success') {
                if (data.replies) {
                    // Takƒ±m Modu
                    data.replies.forEach(r => addMessageToUI(r.agent, r.content, 'agent', getCurrentTime()));
                } else {
                    // Tekil Cevap
                    addMessageToUI(data.agent, data.reply, 'agent', getCurrentTime());
                }
            } else {
                addMessageToUI('Sƒ∞STEM', 'Hata: ' + data.reply, 'agent', getCurrentTime());
            }
        } catch (e) {
            showTyping(false);
            addMessageToUI('Sƒ∞STEM', 'Sunucu baƒülantƒ± hatasƒ±.', 'agent', getCurrentTime());
        }
    }

    function addMessageToUI(sender, text, type, time) {
        const area = document.getElementById('messages-area');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        
        let color = agentColors[sender] || '#fff';
        if (sender === 'Siz') color = '#fff';

        // Markdown Render
        const rawContent = marked.parse(text || "");
        
        div.innerHTML = `
            ${type === 'agent' ? `<span class="msg-sender" style="color:${color}">${sender}</span>` : ''}
            <div class="msg-content">${rawContent}</div>
            <div class="msg-time">${time}</div>
        `;
        
        area.appendChild(div);
        scrollToBottom();
        
        // Kod bloklarƒ±nƒ± boya (yeni eklenenler i√ßin)
        div.querySelectorAll('pre code').forEach((block) => {
            highlight.highlightElement(block);
        });
    }

    function scrollToBottom() {
        const area = document.getElementById('messages-area');
        area.scrollTop = area.scrollHeight;
    }

    function showTyping(show) {
        const indicator = document.getElementById('typing-indicator');
        indicator.style.display = show ? 'flex' : 'none';
    }

    function getCurrentTime() {
        return new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
    }

    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    // --- DOSYA Y√ñNETƒ∞Mƒ∞ ---
    function handleFile() {
        const file = document.getElementById('file-input').files[0];
        if (file) {
            const preview = document.getElementById('file-preview');
            preview.innerHTML = `<i class="fas fa-file"></i> ${file.name} <i class="fas fa-times" onclick="clearFile()" style="margin-left:10px; cursor:pointer;"></i>`;
            preview.style.display = 'block';
        }
    }
    
    function clearFile() {
        document.getElementById('file-input').value = '';
        document.getElementById('file-preview').style.display = 'none';
    }

    // --- KAMERA ---
    async function captureSnapshot() {
        const video = document.getElementById('auth-video');
        const canvas = document.getElementById('auth-canvas');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            await new Promise(resolve => video.onloadedmetadata = () => { video.play(); resolve(); });
            await new Promise(r => setTimeout(r, 300)); // I≈üƒ±k ayarƒ± i√ßin bekle
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            stream.getTracks().forEach(track => track.stop());
            return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
        } catch (e) {
            console.log("Kamera izni yok veya hata:", e);
            return null;
        }
    }

    // --- SES KONTROLLERƒ∞ ---
    async function toggleBackendVoice() {
        const btn = document.getElementById('voice-call-btn');
        try {
            const res = await fetch('/api/toggle_voice', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({}) });
            const data = await res.json();
            if (data.active) {
                btn.style.color = '#4caf50';
                btn.classList.add('fa-beat-fade');
            } else {
                btn.style.color = 'var(--text-secondary)';
                btn.classList.remove('fa-beat-fade');
            }
        } catch (e) { console.error(e); }
    }

    function toggleLocalVoice() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Sesli komut i√ßin Google Chrome kullanƒ±n.");
            return;
        }
        const recognition = new webkitSpeechRecognition();
        recognition.lang = "tr-TR";
        const btn = document.getElementById('mic-btn');
        
        recognition.onstart = () => { btn.style.color = '#ef5350'; document.getElementById('msg-input').placeholder = "Dinliyorum..."; };
        recognition.onend = () => { btn.style.color = 'var(--text-secondary)'; document.getElementById('msg-input').placeholder = "Bir komut girin..."; };
        recognition.onresult = (e) => {
            document.getElementById('msg-input').value = e.results[0][0].transcript;
            sendMessage();
        };
        recognition.start();
    }
</script>

</body>
</html>